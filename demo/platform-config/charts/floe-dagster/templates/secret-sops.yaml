{{/*
SOPS-Decrypted Secret Template for floe-dagster

Creates Kubernetes Secrets from SOPS-decrypted values.
Use with sops -d values-sops.enc.yaml | helm upgrade ... -f -

Covers: 007-FR-003 (SOPS integration)
*/}}
{{- if .Values.secrets }}
{{- $fullname := include "floe-dagster.fullname" . }}
{{- $labels := include "floe-dagster.labels" . }}

{{/*
PostgreSQL Database Secret from SOPS values
*/}}
{{- if .Values.secrets.postgresql }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-postgresql-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
stringData:
  {{- with .Values.secrets.postgresql }}
  {{- if .password }}
  postgresql-password: {{ .password | quote }}
  {{- end }}
  {{- if .username }}
  postgresql-username: {{ .username | quote }}
  {{- end }}
  {{- if .host }}
  postgresql-host: {{ .host | quote }}
  {{- end }}
  {{- if .port }}
  postgresql-port: {{ .port | quote }}
  {{- end }}
  {{- if .database }}
  postgresql-database: {{ .database | quote }}
  {{- end }}
  {{- end }}
---
{{- end }}

{{/*
Compute Engine Secret from SOPS values (Snowflake, BigQuery, etc.)
*/}}
{{- if .Values.secrets.snowflake }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-compute-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: compute
type: Opaque
stringData:
  {{- with .Values.secrets.snowflake }}
  {{- if .account }}
  SNOWFLAKE_ACCOUNT: {{ .account | quote }}
  {{- end }}
  {{- if .user }}
  SNOWFLAKE_USER: {{ .user | quote }}
  {{- end }}
  {{- if .password }}
  SNOWFLAKE_PASSWORD: {{ .password | quote }}
  {{- end }}
  {{- if .warehouse }}
  SNOWFLAKE_WAREHOUSE: {{ .warehouse | quote }}
  {{- end }}
  {{- if .database }}
  SNOWFLAKE_DATABASE: {{ .database | quote }}
  {{- end }}
  {{- if .schema }}
  SNOWFLAKE_SCHEMA: {{ .schema | quote }}
  {{- end }}
  {{- if .role }}
  SNOWFLAKE_ROLE: {{ .role | quote }}
  {{- end }}
  {{- end }}
---
{{- end }}

{{/*
Storage Secret from SOPS values (S3, GCS, ADLS)
*/}}
{{- if .Values.secrets.s3 }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-storage-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: storage
type: Opaque
stringData:
  {{- with .Values.secrets.s3 }}
  {{- if .accessKeyId }}
  AWS_ACCESS_KEY_ID: {{ .accessKeyId | quote }}
  {{- end }}
  {{- if .secretAccessKey }}
  AWS_SECRET_ACCESS_KEY: {{ .secretAccessKey | quote }}
  {{- end }}
  {{- if .region }}
  AWS_REGION: {{ .region | quote }}
  {{- end }}
  {{- end }}
---
{{- end }}

{{/*
Catalog Secret from SOPS values (Polaris OAuth2)
*/}}
{{- if .Values.secrets.polaris }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-catalog-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: catalog
type: Opaque
stringData:
  {{- with .Values.secrets.polaris }}
  {{- if .clientId }}
  polaris-client-id: {{ .clientId | quote }}
  {{- end }}
  {{- if .clientSecret }}
  polaris-client-secret: {{ .clientSecret | quote }}
  {{- end }}
  {{- end }}
---
{{- end }}

{{/*
Custom Secrets from SOPS values
*/}}
{{- range $name, $data := .Values.secrets.custom }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-{{ $name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
type: Opaque
stringData:
  {{- range $key, $value := $data }}
  {{ $key }}: {{ $value | quote }}
  {{- end }}
---
{{- end }}
{{- end }}
