# External Secrets with AWS Secrets Manager
#
# This example shows how to configure floe-dagster to sync secrets
# from AWS Secrets Manager using External Secrets Operator.
#
# Prerequisites:
# 1. External Secrets Operator installed in cluster
# 2. AWS credentials configured (IRSA, access keys, or instance profile)
# 3. SecretStore configured to access AWS Secrets Manager
#
# Covers: 007-FR-003 (External Secrets integration)
#
# Usage:
#   helm upgrade floe-dagster charts/floe-dagster \
#     -f charts/floe-dagster/values-external-secrets-aws.yaml \
#     --namespace floe
#
# Step 1: Create SecretStore first (kubectl apply):
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: aws-secrets-manager
#   namespace: floe
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-west-2
#       auth:
#         # IRSA (Recommended for EKS)
#         jwt:
#           serviceAccountRef:
#             name: external-secrets-sa

floe:
  externalSecrets:
    enabled: true

    # Reference the SecretStore created above
    secretStoreRef: "aws-secrets-manager"
    secretStoreKind: "SecretStore"

    # Refresh secrets every 15 minutes
    refreshInterval: "15m"

    # PostgreSQL credentials from AWS Secrets Manager
    # AWS Secret: floe/prod/dagster-postgresql (JSON format)
    # {
    #   "username": "dagster",
    #   "password": "your-secure-password",
    #   "host": "dagster-db.cluster-xxx.us-west-2.rds.amazonaws.com",
    #   "port": "5432",
    #   "database": "dagster"
    # }
    postgresql:
      enabled: true
      passwordKey: "floe/prod/dagster-postgresql"
      passwordProperty: "password"
      usernameKey: "floe/prod/dagster-postgresql"
      usernameProperty: "username"
      hostKey: "floe/prod/dagster-postgresql"
      hostProperty: "host"

    # Snowflake credentials from AWS Secrets Manager
    # AWS Secret: floe/prod/snowflake (JSON format)
    compute:
      enabled: true
      secrets:
        - secretKey: SNOWFLAKE_ACCOUNT
          remoteKey: "floe/prod/snowflake"
          property: "account"
        - secretKey: SNOWFLAKE_USER
          remoteKey: "floe/prod/snowflake"
          property: "user"
        - secretKey: SNOWFLAKE_PASSWORD
          remoteKey: "floe/prod/snowflake"
          property: "password"
        - secretKey: SNOWFLAKE_WAREHOUSE
          remoteKey: "floe/prod/snowflake"
          property: "warehouse"
        - secretKey: SNOWFLAKE_DATABASE
          remoteKey: "floe/prod/snowflake"
          property: "database"

    # S3 credentials (if not using IRSA)
    storage:
      enabled: true
      secrets:
        - secretKey: AWS_ACCESS_KEY_ID
          remoteKey: "floe/prod/s3-credentials"
          property: "access_key"
        - secretKey: AWS_SECRET_ACCESS_KEY
          remoteKey: "floe/prod/s3-credentials"
          property: "secret_key"

    # Polaris catalog OAuth2 credentials
    catalog:
      enabled: true
      clientIdKey: "floe/prod/polaris"
      clientIdProperty: "client_id"
      clientSecretKey: "floe/prod/polaris"
      clientSecretProperty: "client_secret"

# Override Dagster PostgreSQL configuration to use external secret
dagster:
  postgresql:
    enabled: false
  global:
    postgresqlSecretName: "floe-dagster-postgresql-secret"
    generatePostgresqlPasswordSecret: false
