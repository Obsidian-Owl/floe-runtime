{{- if .Values.localstack.enabled }}
# LocalStack - AWS Service Emulator for Local Development
# Provides S3, STS, IAM, and Secrets Manager for production-aligned testing
# Replaces MinIO for K8s local development (MinIO only provides S3)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-localstack
  labels:
    {{- include "floe-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: localstack
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "floe-infrastructure.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: localstack
  template:
    metadata:
      labels:
        {{- include "floe-infrastructure.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: localstack
    spec:
      containers:
        - name: localstack
          image: "{{ .Values.localstack.image.repository }}:{{ .Values.localstack.image.tag }}"
          imagePullPolicy: {{ .Values.localstack.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: gateway
              containerPort: 4566
              protocol: TCP
          env:
            # Services to enable (S3, STS for credential vending, IAM for role emulation)
            - name: SERVICES
              value: {{ .Values.localstack.services | default "s3,sts,iam,secretsmanager" | quote }}
            - name: DEFAULT_REGION
              value: {{ .Values.localstack.region | default "us-east-1" | quote }}
            # Enable persistence for data across restarts
            - name: PERSISTENCE
              value: {{ .Values.localstack.persistence.enabled | default "0" | quote }}
            # Debug logging (useful for troubleshooting)
            - name: DEBUG
              value: {{ .Values.localstack.debug | default "0" | quote }}
            # Edge port (main gateway)
            - name: GATEWAY_LISTEN
              value: "0.0.0.0:4566"
            # Disable LocalStack Pro features (we use community edition)
            - name: LOCALSTACK_HOST
              value: "localhost.localstack.cloud"
          {{- if .Values.localstack.persistence.enabled }}
          volumeMounts:
            - name: localstack-data
              mountPath: /var/lib/localstack
          {{- end }}
          startupProbe:
            httpGet:
              path: /_localstack/health
              port: gateway
            initialDelaySeconds: {{ ((.Values.localstack).startupProbe).initialDelaySeconds | default 5 }}
            periodSeconds: {{ ((.Values.localstack).startupProbe).periodSeconds | default 3 }}
            failureThreshold: {{ ((.Values.localstack).startupProbe).failureThreshold | default 30 }}  # Allow 1.5 minutes for service initialization
            timeoutSeconds: {{ ((.Values.localstack).startupProbe).timeoutSeconds | default 3 }}
          livenessProbe:
            httpGet:
              path: /_localstack/health
              port: gateway
            initialDelaySeconds: {{ .Values.localstack.livenessProbe.initialDelaySeconds | default 15 }}
            periodSeconds: {{ .Values.localstack.livenessProbe.periodSeconds | default 10 }}
            failureThreshold: {{ .Values.localstack.livenessProbe.failureThreshold | default 3 }}
          readinessProbe:
            httpGet:
              path: /_localstack/health
              port: gateway
            initialDelaySeconds: {{ .Values.localstack.readinessProbe.initialDelaySeconds | default 5 }}
            periodSeconds: {{ .Values.localstack.readinessProbe.periodSeconds | default 5 }}
            failureThreshold: {{ .Values.localstack.readinessProbe.failureThreshold | default 3 }}
          resources:
            {{- toYaml .Values.localstack.resources | nindent 12 }}
      {{- if .Values.localstack.persistence.enabled }}
      volumes:
        - name: localstack-data
          {{- if .Values.localstack.persistence.existingClaim }}
          persistentVolumeClaim:
            claimName: {{ .Values.localstack.persistence.existingClaim }}
          {{- else }}
          emptyDir: {}
          {{- end }}
      {{- end }}
{{- end }}
