{{- if and .Values.localstack.enabled .Values.localstack.init.enabled }}
# LocalStack Initialization Job
# Creates S3 buckets and IAM roles for Polaris credential vending
# Runs as a Helm post-install/post-upgrade hook
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-localstack-init
  labels:
    {{- include "floe-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: localstack-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: {{ .Values.localstack.init.backoffLimit | default 5 }}
  ttlSecondsAfterFinished: {{ .Values.localstack.init.ttlSecondsAfterFinished | default 300 }}
  template:
    metadata:
      labels:
        {{- include "floe-infrastructure.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: localstack-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: "{{ .Values.localstack.init.image.repository }}:{{ .Values.localstack.init.image.tag }}"
          imagePullPolicy: {{ .Values.localstack.init.image.pullPolicy | default "IfNotPresent" }}
          env:
            - name: AWS_ENDPOINT_URL
              value: "http://{{ .Release.Name }}-localstack:4566"
            - name: AWS_ACCESS_KEY_ID
              value: "test"
            - name: AWS_SECRET_ACCESS_KEY
              value: "test"
            - name: AWS_DEFAULT_REGION
              value: {{ .Values.localstack.region | default "us-east-1" | quote }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "=== LocalStack Initialization ==="
              echo "Endpoint: $AWS_ENDPOINT_URL"
              echo "Region: $AWS_DEFAULT_REGION"

              # Wait for LocalStack to be ready
              echo ""
              echo "=== Waiting for LocalStack to be ready ==="
              MAX_ATTEMPTS=30
              ATTEMPT=0
              until curl -sf "$AWS_ENDPOINT_URL/_localstack/health" > /dev/null 2>&1; do
                ATTEMPT=$((ATTEMPT + 1))
                if [[ $ATTEMPT -eq $MAX_ATTEMPTS ]]; then
                  echo "ERROR: LocalStack not ready after $MAX_ATTEMPTS attempts" >&2
                  exit 1
                fi
                echo "Waiting for LocalStack... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
                sleep 2
              done
              echo "LocalStack is ready!"

              # Create S3 buckets
              echo ""
              echo "=== Creating S3 Buckets ==="
              {{- range .Values.localstack.init.buckets }}
              echo "Creating bucket: {{ .name }}"
              aws s3 mb "s3://{{ .name }}" --endpoint-url "$AWS_ENDPOINT_URL" || echo "Bucket {{ .name }} may already exist"
              {{- end }}

              # Create IAM role for Polaris credential vending
              echo ""
              echo "=== Creating IAM Role for Polaris Credential Vending ==="

              # Trust policy allowing Polaris to assume this role
              cat > /tmp/trust-policy.json << 'TRUST_EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "Service": "polaris.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                  },
                  {
                    "Effect": "Allow",
                    "Principal": {
                      "AWS": "*"
                    },
                    "Action": "sts:AssumeRole"
                  }
                ]
              }
              TRUST_EOF

              echo "Creating IAM role: {{ .Values.localstack.init.iamRole.name | default "polaris-storage-role" }}"
              aws iam create-role \
                --role-name {{ .Values.localstack.init.iamRole.name | default "polaris-storage-role" | quote }} \
                --assume-role-policy-document file:///tmp/trust-policy.json \
                --endpoint-url "$AWS_ENDPOINT_URL" || echo "Role may already exist"

              # S3 access policy for Iceberg tables
              echo ""
              echo "=== Attaching S3 Policy to Role ==="
              cat > /tmp/s3-policy.json << 'S3_EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "s3:GetObject",
                      "s3:PutObject",
                      "s3:DeleteObject",
                      "s3:ListBucket",
                      "s3:GetBucketLocation"
                    ],
                    "Resource": [
                      {{- $buckets := .Values.localstack.init.buckets }}
                      {{- range $index, $bucket := $buckets }}
                      "arn:aws:s3:::{{ $bucket.name }}",
                      "arn:aws:s3:::{{ $bucket.name }}/*"{{ if lt $index (sub (len $buckets) 1) }},{{ end }}
                      {{- end }}
                    ]
                  }
                ]
              }
              S3_EOF

              aws iam put-role-policy \
                --role-name {{ .Values.localstack.init.iamRole.name | default "polaris-storage-role" | quote }} \
                --policy-name s3-access \
                --policy-document file:///tmp/s3-policy.json \
                --endpoint-url "$AWS_ENDPOINT_URL" || echo "Policy may already exist"

              # Store Polaris credentials in Secrets Manager (optional)
              {{- if .Values.localstack.init.secretsManager.enabled }}
              echo ""
              echo "=== Creating Secrets in Secrets Manager ==="
              aws secretsmanager create-secret \
                --name "floe/polaris-client-id" \
                --secret-string "{{ .Values.polarisInit.oauthClientId | default "demo_client" }}" \
                --endpoint-url "$AWS_ENDPOINT_URL" || echo "Secret may already exist"

              aws secretsmanager create-secret \
                --name "floe/polaris-client-secret" \
                --secret-string "{{ .Values.polarisInit.oauthClientSecret | default "demo_secret" }}" \
                --endpoint-url "$AWS_ENDPOINT_URL" || echo "Secret may already exist"
              {{- end }}

              # Verify setup
              echo ""
              echo "=== Verification ==="
              echo "S3 Buckets:"
              aws s3 ls --endpoint-url "$AWS_ENDPOINT_URL"

              echo ""
              echo "IAM Roles:"
              aws iam list-roles --endpoint-url "$AWS_ENDPOINT_URL" --query 'Roles[*].RoleName' --output text

              echo ""
              echo "=== LocalStack Initialization Complete ==="
          resources:
            {{- toYaml .Values.localstack.init.resources | nindent 12 }}
{{- end }}
