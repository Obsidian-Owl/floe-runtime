# Default values for floe-infrastructure
# This is a YAML-formatted file.

# Global settings
global:
  storageClass: ""

# Platform Configuration (Two-Tier Architecture)
# This ConfigMap injects platform.yaml into the cluster for apps to consume
# Usage: helm install ... --set-file platformConfig.content=./platform/local/platform.yaml
platformConfig:
  # Enable platform.yaml ConfigMap injection
  enabled: false
  # Platform.yaml content - set via --set-file platformConfig.content=path/to/platform.yaml
  content: ""
  # Mount path in pods (standard location)
  mountPath: /etc/floe/platform.yaml
  # ConfigMap name override (default: {{ .Release.Name }}-platform-config)
  nameOverride: ""

# PostgreSQL configuration (Dagster + Marquez metadata)
postgresql:
  enabled: true
  auth:
    postgresPassword: "floe-postgres"
    database: "dagster"
  primary:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

# MinIO configuration (Iceberg storage)
minio:
  enabled: true
  mode: standalone
  rootUser: minioadmin
  rootPassword: minioadmin
  persistence:
    enabled: true
    size: 10Gi
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  buckets:
    - name: iceberg-data
      policy: none
      purge: false
    - name: cube-preaggs
      policy: none
      purge: false
  consoleIngress:
    enabled: false

# Polaris configuration (Iceberg REST catalog)
polaris:
  enabled: true
  image:
    repository: apache/polaris
    tag: "0.9.0"
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    type: ClusterIP
    port: 8181
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Polaris uses PostgreSQL for metadata
  persistence:
    type: postgres
    postgres:
      host: "{{ .Release.Name }}-postgresql"
      port: 5432
      database: polaris
      username: postgres
      existingSecret: ""
      secretPasswordKey: postgres-password

# Jaeger configuration (distributed tracing)
jaeger:
  enabled: true
  provisionDataStore:
    cassandra: false
  allInOne:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
  storage:
    type: memory
  agent:
    enabled: false
  collector:
    enabled: false
  query:
    enabled: false

# Marquez configuration (data lineage)
marquez:
  enabled: true
  image:
    repository: marquezproject/marquez
    tag: "0.49.0"
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    type: ClusterIP
    port: 5000
    apiPort: 5001
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Marquez Web UI
  web:
    enabled: true
    image:
      repository: marquezproject/marquez-web
      tag: "0.49.0"
      pullPolicy: IfNotPresent
    service:
      type: ClusterIP
      port: 3001
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
  # Marquez uses PostgreSQL for metadata
  postgres:
    host: "{{ .Release.Name }}-postgresql"
    port: 5432
    database: marquez
    username: postgres
    existingSecret: ""
    secretPasswordKey: postgres-password

# LocalStack configuration (AWS service emulator for local development)
# Replaces MinIO when enabled - provides S3 + STS + IAM + Secrets Manager
# Use for production-aligned testing with credential vending support
localstack:
  enabled: false  # Set to true to use LocalStack instead of MinIO
  image:
    repository: localstack/localstack
    tag: "3.0"
    pullPolicy: IfNotPresent
  # AWS services to enable
  services: "s3,sts,iam,secretsmanager"
  region: "us-east-1"
  # Enable debug logging
  debug: "0"
  # Persistence configuration
  persistence:
    enabled: false  # Uses emptyDir by default
    existingClaim: ""
  # Resource limits
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  # Health check configuration
  livenessProbe:
    initialDelaySeconds: 15
    periodSeconds: 10
    failureThreshold: 3
  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 5
    failureThreshold: 3
  # Initialization job configuration
  init:
    enabled: true
    image:
      repository: amazon/aws-cli
      tag: "2.15.0"
      pullPolicy: IfNotPresent
    # S3 buckets to create
    buckets:
      - name: iceberg-data
      - name: cube-preaggs
    # IAM role for Polaris credential vending
    iamRole:
      name: "polaris-storage-role"
    # Store credentials in Secrets Manager
    secretsManager:
      enabled: false
    # Job configuration
    backoffLimit: 5
    ttlSecondsAfterFinished: 300
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

# Polaris initialization job
polarisInit:
  enabled: true
  catalogName: "demo_catalog"
  namespaces:
    - "bronze"
    - "silver"
    - "gold"
  storageLocation: "s3://iceberg-data/"
  oauthClientId: "demo_client"
  storageRoleArn: ""  # Empty for LocalStack (static credentials), set for production AWS

# Seed data initialization for demo
# Creates demo.raw_* tables with synthetic e-commerce data
# Runs AFTER polaris-init (hook-weight: 10 > 5)
seedData:
  enabled: false  # Disabled by default, enable in values-local.yaml
  image:
    repository: "ghcr.io/obsidian-owl/floe-demo"
    tag: "latest"
    pullPolicy: IfNotPresent
  # AWS credentials for S3 access
  awsAccessKeyId: ""
  awsSecretAccessKey: ""
  # Data volume configuration
  seed: 42
  customersCount: 1000
  productsCount: 100
  ordersCount: 5000
  orderItemsCount: 10000

# Resource quotas (disabled for local development)
resourceQuota:
  enabled: false
  limits:
    pods: "50"
    requests_cpu: "10"
    limits_cpu: "20"
    requests_memory: "20Gi"
    limits_memory: "24Gi"

# Limit ranges (disabled for local development)
limitRange:
  enabled: false
  limits:
    container:
      min_cpu: "50m"
      max_cpu: "4"
      min_memory: "64Mi"
      max_memory: "8Gi"

# Local access configuration
localAccess:
  nodeports:
    jaeger: 30686
    marquez: 30500
    polaris: 30181
    dagster: 30000
    cube: 30400
