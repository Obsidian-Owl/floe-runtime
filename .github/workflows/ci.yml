name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs on the same branch (trunk-based development)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      # Pin to full SHA for security (immutable reference)
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a  # v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run ruff check
        run: uv run ruff check .

      - name: Run ruff format
        run: uv run ruff format --check .
      # Note: ruff check (above) includes I001 import sorting via [tool.ruff.lint] select = ["I"]
      # This replaces the need for a separate isort check

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a  # v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run mypy
        run: uv run mypy --strict packages/*/src/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a  # v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run bandit
        run: uv run bandit -r packages/*/src/ -ll

      - name: Run pip-audit
        run: uv run pip-audit

  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Helm
        uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814  # v4
        with:
          version: v3.14.0

      - name: Build chart dependencies
        run: |
          helm dependency update charts/floe-dagster/
          helm dependency update charts/floe-cube/

      - name: Lint floe-dagster chart
        run: helm lint charts/floe-dagster/

      - name: Lint floe-cube chart
        run: helm lint charts/floe-cube/

      - name: Template validation (floe-dagster)
        run: helm template test-release charts/floe-dagster/ > /dev/null

      - name: Template validation (floe-cube)
        run: helm template test-release charts/floe-cube/ > /dev/null

  test:
    name: Test (All tests in Docker)
    runs-on: ubuntu-latest
    # ALL tests run inside Docker for consistent hostname resolution
    # This ensures unit, contract, and integration tests all work reliably
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Run all tests via Docker test runner
        run: ./testing/docker/scripts/run-all-tests.sh

      - name: Upload coverage report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 1
          if-no-files-found: warn

      - name: Show Docker logs on failure
        if: failure()
        working-directory: testing/docker
        run: docker compose --profile full logs --tail=100

      - name: Stop Docker infrastructure
        if: always()
        working-directory: testing/docker
        run: docker compose --profile full down -v

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test]  # Wait for tests to complete so coverage.xml is available
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0  # Full history for accurate blame information

      - name: Download coverage report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4
        with:
          name: coverage-report
          path: .
        continue-on-error: true  # Don't fail if coverage wasn't generated

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@2500896589ef8f7247069a56136f8dc177c27ccf  # v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}

  traceability:
    name: Traceability Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Install uv
        uses: astral-sh/setup-uv@38f3f104447c67c051c4a08e39b64a148898af3a  # v4
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Generate traceability report with 80% threshold
        run: ./testing/docker/scripts/run-traceability.sh --threshold 80 --format console

      - name: Generate JSON report for artifacts
        run: ./testing/docker/scripts/run-traceability.sh --format json > traceability-report.json
        continue-on-error: true

      - name: Upload traceability report
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4
        if: always()
        with:
          name: traceability-report
          path: traceability-report.json
          retention-days: 30
