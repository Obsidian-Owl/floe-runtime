name: Integration Tests

on:
  # Allow manual trigger for running integration tests independently
  workflow_dispatch:

# Cancel in-progress runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Integration Tests (Docker)
    runs-on: ubuntu-latest
    # This workflow is for manual runs of integration tests only.
    # The main CI workflow (ci.yml) runs ALL tests in Docker automatically.
    steps:
      # Pin to full SHA for security (immutable reference)
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3

      - name: Run integration tests via script
        run: ./testing/docker/scripts/run-integration-tests.sh --profile full

      - name: Show logs on failure
        if: failure()
        working-directory: testing/docker
        run: docker compose --profile full logs --tail=100

      - name: Cleanup
        if: always()
        working-directory: testing/docker
        run: docker compose --profile full down -v
