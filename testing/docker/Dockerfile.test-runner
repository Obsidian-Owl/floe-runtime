# Test runner container for integration tests
# Runs on the same Docker network as services, enabling proper hostname resolution
#
# Usage:
#   docker compose --profile test run --rm test-runner
#   docker compose --profile test run --rm test-runner uv run pytest packages/floe-iceberg/tests/integration/ -v
#
# Note: The workspace is mounted at runtime, so dependencies are installed
# when the container starts. This ensures local packages are available.

FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for fast dependency management
RUN pip install --no-cache-dir uv

# Create non-root user for security
# Using UID/GID 1000 to match common host user IDs for volume permissions
RUN groupadd --gid 1000 testrunner \
    && useradd --uid 1000 --gid 1000 --create-home testrunner

WORKDIR /workspace

# Change ownership to non-root user
RUN chown -R testrunner:testrunner /workspace

USER testrunner

# Set environment variables for container context
ENV DOCKER_CONTAINER=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
# Use copy mode for uv since we're mounting a volume
ENV UV_LINK_MODE=copy

# Default entrypoint: sync dependencies and run command
# This ensures local packages are installed before running tests
ENTRYPOINT ["/bin/sh", "-c", "uv sync --all-packages && exec \"$@\"", "--"]
CMD ["uv", "run", "pytest", "-m", "integration", "-v"]
