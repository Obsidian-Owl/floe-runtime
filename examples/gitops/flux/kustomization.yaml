# Flux Kustomization for floe-runtime
#
# This Kustomization orchestrates the deployment order and
# provides environment-specific patching.
#
# Deploy with: kubectl apply -f kustomization.yaml
#
# Covers: 007-FR-003 (environment promotion pipeline)
# Covers: 007-FR-004 (GitOps deployment with Flux)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: floe-runtime
  namespace: flux-system
spec:
  interval: 10m
  timeout: 5m

  sourceRef:
    kind: GitRepository
    name: floe-project
    namespace: flux-system

  # Path to the Kustomize overlay or raw manifests
  path: ./examples/gitops/flux

  # Prune resources that are no longer in source
  prune: true

  # Wait for resources to be ready
  wait: true

  # Health checks
  healthChecks:
    - apiVersion: apps/v1
      kind: Deployment
      name: floe-dagster-webserver
      namespace: floe
    - apiVersion: apps/v1
      kind: Deployment
      name: floe-cube-api
      namespace: floe

  # Post-build variable substitution
  postBuild:
    substitute:
      ENVIRONMENT: development
      DOMAIN: floe.local
    substituteFrom:
      - kind: ConfigMap
        name: cluster-config
        optional: true
      - kind: Secret
        name: cluster-secrets
        optional: true

  # Decryption for SOPS-encrypted secrets
  decryption:
    provider: sops
    secretRef:
      name: sops-age-key

  # Dependencies - deploy in order
  dependsOn:
    - name: namespaces
    - name: external-secrets

  # Service account for impersonation
  serviceAccountName: flux-reconciler

---
# Development environment Kustomization
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: floe-runtime-dev
  namespace: flux-system
spec:
  interval: 5m
  sourceRef:
    kind: GitRepository
    name: floe-project
    namespace: flux-system
  path: ./examples/environments/dev
  prune: true
  wait: true
  targetNamespace: floe-dev
  postBuild:
    substitute:
      ENVIRONMENT: dev

---
# Staging environment Kustomization
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: floe-runtime-staging
  namespace: flux-system
spec:
  interval: 5m
  sourceRef:
    kind: GitRepository
    name: floe-project
    namespace: flux-system
  path: ./examples/environments/staging
  prune: true
  wait: true
  targetNamespace: floe-staging
  dependsOn:
    - name: floe-runtime-dev
  postBuild:
    substitute:
      ENVIRONMENT: staging

---
# Production environment Kustomization
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: floe-runtime-prod
  namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: floe-project
    namespace: flux-system
  path: ./examples/environments/prod
  prune: true
  wait: true
  targetNamespace: floe-prod
  dependsOn:
    - name: floe-runtime-staging
  postBuild:
    substitute:
      ENVIRONMENT: prod
  # Manual gate for production
  suspend: true
