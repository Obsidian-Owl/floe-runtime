# Kubernetes Local Platform Configuration
#
# Environment: k8s-local
# Purpose: Local Kubernetes deployment (Docker Desktop)
# Schema Version: 1.1.0 (Enterprise features)
#
# Two-Tier Configuration Architecture:
# - This file is injected as a ConfigMap by floe-infrastructure chart
# - Dagster pods mount the ConfigMap at /etc/floe/platform.yaml
# - PlatformResolver loads config via FLOE_PLATFORM_FILE env var
#
# Usage:
#   make deploy-local-infra   # Injects this as ConfigMap
#   make deploy-local-dagster # Mounts ConfigMap
#
# Required environment variables (injected from K8s Secrets):
#   POLARIS_CLIENT_ID      - OAuth2 client ID for Polaris
#   POLARIS_CLIENT_SECRET  - OAuth2 client secret for Polaris
#   AWS_ACCESS_KEY_ID      - LocalStack access key (any value works)
#   AWS_SECRET_ACCESS_KEY  - LocalStack secret key (any value works)
#
# Infrastructure (floe-infrastructure chart):
#   - Storage: LocalStack S3 (http://floe-infra-localstack:4566)
#   - Catalog: Polaris (http://floe-infra-polaris:8181)
#   - Observability: Jaeger + Marquez
#
# Service URLs (NodePort - resilient to pod restarts):
#   - Dagster UI:     http://localhost:30000
#   - Polaris API:    http://localhost:30181
#   - LocalStack:     http://localhost:30566  (S3, STS, IAM, Secrets Manager)
#   - Jaeger UI:      http://localhost:30686
#   - Marquez Web:    http://localhost:30301
#   - Marquez API:    http://localhost:30500
#
# Covers: 009-US2 (Same floe.yaml works across dev/staging/prod)

version: "1.1.0"

# =============================================================================
# Infrastructure Configuration (v1.1.0)
# =============================================================================
infrastructure:
  network:
    enabled: true
    dns:
      internal_domain: floe.local
      strategy: kubernetes
    # NodePort for resilient local access (survives pod restarts)
    local_access:
      enabled: true
      access_type: nodeport
      ports:
        dagster: 30000
        polaris: 30181
        localstack: 30566
        jaeger: 30686
        marquez_web: 30301
        marquez_api: 30500
  cloud:
    provider: local
    localstack:
      enabled: true  # Using LocalStack for S3 + STS + IAM
      endpoint: "http://floe-infra-localstack:4566"
      services:
        - s3
        - sts
        - iam
        - secretsmanager

# =============================================================================
# Security Configuration (v1.1.0)
# =============================================================================
security:
  authentication:
    enabled: false  # No auth for local development
    method: static
  authorization:
    enabled: false
  secret_backends:
    primary: kubernetes
    kubernetes:
      enabled: true
      namespace: floe
      mount_path: /var/run/secrets
  encryption:
    in_transit:
      enabled: false  # TLS disabled for local dev
    at_rest:
      enabled: false

# =============================================================================
# Governance Configuration (v1.1.0)
# =============================================================================
governance:
  classifications:
    enabled: false  # Disabled for local development
  retention:
    enabled: false
  compliance:
    enabled: false
  data_quality:
    enabled: false

# =============================================================================
# Storage Profiles - Medallion Architecture (Bronze/Silver/Gold)
# =============================================================================
# Best Practice: Separate buckets per layer for:
# - Layer-specific access controls (Bronze: read-only, Silver: transform, Gold: public)
# - Differentiated retention policies (Bronze: 7 years, Silver: 2 years, Gold: 90 days)
# - Performance isolation (Bronze: high write, Gold: high read)
# - Compliance (GDPR/CCPA data minimization)
storage:
  # Bronze Layer: Raw and lightly cleaned data
  # - Retention: Long-term (7 years for audit trail)
  # - Access: Data engineers (read-only)
  # - Performance: Optimized for bulk writes
  bronze:
    type: s3
    endpoint: "http://floe-infra-localstack:4566"
    region: us-east-1
    bucket: iceberg-bronze
    path_style_access: true
    credentials:
      mode: static
      secret_ref: aws-credentials

  # Silver Layer: Cleaned, deduplicated, enriched data
  # - Retention: Medium-term (2 years)
  # - Access: Data engineers and analysts (read-only)
  # - Performance: Balanced read/write
  silver:
    type: s3
    endpoint: "http://floe-infra-localstack:4566"
    region: us-east-1
    bucket: iceberg-silver
    path_style_access: true
    credentials:
      mode: static
      secret_ref: aws-credentials

  # Gold Layer: Aggregated marts for analytics
  # - Retention: Short-term (90 days)
  # - Access: Public via semantic layer
  # - Performance: Optimized for analytical queries
  gold:
    type: s3
    endpoint: "http://floe-infra-localstack:4566"
    region: us-east-1
    bucket: iceberg-gold
    path_style_access: true
    credentials:
      mode: static
      secret_ref: aws-credentials

  # Default alias points to bronze for backward compatibility
  default:
    type: s3
    endpoint: "http://floe-infra-localstack:4566"
    region: us-east-1
    bucket: iceberg-bronze
    path_style_access: true
    credentials:
      mode: static
      secret_ref: aws-credentials

catalogs:
  default:
    type: polaris
    # Polaris endpoint in K8s (floe-infrastructure chart)
    uri: "http://floe-infra-polaris:8181/api/catalog"
    warehouse: demo_catalog
    namespace: default
    credentials:
      mode: oauth2
      # Resolved from POLARIS_CLIENT_ID env var
      client_id:
        secret_ref: polaris-client-id
      client_secret:
        secret_ref: polaris-client-secret
      scope: "PRINCIPAL_ROLE:DATA_ENGINEER"
    # Disable vended credentials for LocalStack (STS support varies)
    access_delegation: none
    token_refresh_enabled: true

compute:
  default:
    type: duckdb
    properties:
      path: ":memory:"
      threads: 4
    credentials:
      mode: static

# =============================================================================
# Observability Configuration (Extended in v1.1.0)
# =============================================================================
observability:
  traces: true
  metrics: true
  lineage: true
  # Jaeger OTLP endpoint in K8s (floe-infrastructure chart)
  otlp_endpoint: "http://floe-infra-jaeger-collector:4317"
  # Marquez endpoint in K8s (floe-infrastructure chart)
  lineage_endpoint: "http://floe-infra-marquez:5000"
  attributes:
    service.name: floe-k8s-local
    deployment.environment: k8s-local
  # Extended tracing configuration (v1.1.0)
  tracing:
    sampling:
      sampling_type: always_on  # Full tracing for local dev
      probability: 1.0
    exporters:
      jaeger: true
      xray: false
  # Extended metrics configuration (v1.1.0)
  metrics_config:
    scrape_interval: "15s"
    retention_days: 7
    exporters:
      prometheus: true
      cloudwatch: false
  # Extended logging configuration (v1.1.0)
  logging:
    level: INFO
    log_format: json
    backends:
      loki: false  # Not deployed in local K8s
      cloudwatch: false
