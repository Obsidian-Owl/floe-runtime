# Floe Dagster Helm Chart Values
#
# Default configuration values for floe-dagster chart.
# Override in values-dev.yaml or values-prod.yaml for environment-specific settings.
#
# Covers: 007-FR-001 (Helm chart for Kubernetes deployment)

# Enable/disable the dagster subchart
dagster:
  enabled: true

  # ==========================================================================
  # Self-Healing Configuration (Embedded Infrastructure Behavior)
  # ==========================================================================
  # These probes ensure pods auto-restart when they become unhealthy.
  # Users don't need to configure these - they're baked in.

  dagsterWebserver:
    # Liveness probe: restart webserver if it becomes unresponsive
    livenessProbe:
      httpGet:
        path: /server_info
        port: 80
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    # Startup probe: allow up to 5 minutes for initial startup
    startupProbe:
      enabled: true
      httpGet:
        path: /server_info
        port: 80
      periodSeconds: 10
      failureThreshold: 30
      timeoutSeconds: 10

  dagsterDaemon:
    # Reduced heartbeat tolerance for faster detection of hung scheduler
    # Default is 1800s (30min), we use 300s (5min) for quicker recovery
    heartbeatTolerance: 300
    # Liveness probe using built-in daemon health check
    # Checks heartbeats from all daemon threads including SCHEDULER
    livenessProbe:
      exec:
        command: ["dagster-daemon", "liveness-check"]
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
    # Startup probe: allow daemon threads to initialize
    startupProbe:
      enabled: true
      exec:
        command: ["dagster-daemon", "liveness-check"]
      periodSeconds: 10
      failureThreshold: 30
      timeoutSeconds: 10

# Floe-specific configuration
floe:
  # Platform Specification (Two-Tier Architecture)
  # Platform engineers configure infrastructure via platform.yaml
  # Data engineers configure pipelines via floe.yaml (references profiles by name)
  # Same floe.yaml works across environments by swapping platform.yaml
  # Covers: 009-US2 (Same floe.yaml works across dev/staging/prod)
  platformSpec:
    # Enable Platform ConfigMap creation (creates own ConfigMap)
    enabled: false
    # Mount path inside containers (FLOE_PLATFORM_FILE env var points here)
    mountPath: "/app/.floe/platform.yaml"
    # Raw platform.yaml content (set via --set-file or values override)
    # If set, overrides all structured fields below
    content: ""
    # Additional annotations for the ConfigMap
    annotations: {}

  # External Platform ConfigMap (Two-Tier Architecture - Preferred)
  # Mount an existing platform ConfigMap from floe-infrastructure chart
  # This is the preferred approach: single source of truth for platform config
  # Covers: 009-US2 (Same floe.yaml works across dev/staging/prod)
  externalPlatformConfig:
    # Enable mounting external platform ConfigMap (from floe-infrastructure)
    enabled: false
    # Name of the external ConfigMap (e.g., "floe-infra-platform-config")
    configMapName: ""
    # Key within the ConfigMap containing platform.yaml
    configMapKey: "platform.yaml"
    # Mount path inside containers
    mountPath: "/etc/floe/platform.yaml"
    # Set FLOE_PLATFORM_FILE env var to point to mounted config
    setEnvVar: true

    # Storage profile configuration
    storage:
      type: s3
      endpoint: ""  # Empty = AWS S3, else MinIO/LocalStack URL
      region: us-east-1
      bucket: iceberg-data
      pathStyleAccess: false
      credentials:
        mode: static  # static | iam_role | oauth2
        secretRef: ""  # K8s secret name for credentials
        roleArn: ""  # For iam_role mode

    # Catalog profile configuration (Polaris)
    catalog:
      type: polaris
      uri: ""  # Polaris REST API endpoint
      warehouse: ""
      namespace: default
      credentials:
        mode: oauth2
        clientId: ""
        secretRef: ""  # K8s secret with client_secret
        scope: "PRINCIPAL_ROLE:DATA_ENGINEER"
      accessDelegation: ""  # vended-credentials for STS
      tokenRefreshEnabled: false

    # Compute profile configuration
    compute:
      type: duckdb  # duckdb | snowflake | bigquery | trino
      properties: {}
      credentials:
        mode: static
        secretRef: ""

    # Observability configuration
    observability:
      traces: true
      metrics: true
      lineage: true
      otlpEndpoint: ""
      lineageEndpoint: ""

  # CompiledArtifacts configuration
  compiledArtifacts:
    # Enable CompiledArtifacts ConfigMap creation
    enabled: true
    # ConfigMap name (leave empty to use generated name)
    configMapName: ""
    # Mount path inside containers
    mountPath: "/app/.floe/compiled_artifacts.json"
    # Content of compiled_artifacts.json (set via --set-file or values override)
    content: ""
    # Additional annotations for the ConfigMap
    annotations: {}

  # External Secrets Operator integration
  # Syncs secrets from external providers (AWS Secrets Manager, Vault, GCP, Azure)
  # Requires: External Secrets Operator installed in cluster
  # Covers: 007-FR-003 (External Secrets integration)
  externalSecrets:
    # Enable External Secrets integration
    enabled: false

    # Secret store reference (required when enabled)
    # This references a SecretStore or ClusterSecretStore resource
    secretStoreRef: ""

    # Secret store kind: SecretStore (namespace-scoped) or ClusterSecretStore (cluster-wide)
    secretStoreKind: "SecretStore"

    # How often to refresh secrets from external provider
    refreshInterval: "1h"

    # Creation policy for target secrets: Owner, Merge, or None
    creationPolicy: "Owner"

    # Common annotations for all ExternalSecret resources
    annotations: {}

    # Template configuration for secret transformation
    template:
      enabled: false
      # Generate connection string from individual fields
      connectionString: false

    # PostgreSQL database credentials
    # Creates secret: {{ fullname }}-postgresql-secret
    postgresql:
      enabled: false
      # Remote key path for password (e.g., /floe/prod/dagster-db or floe/prod/dagster-db)
      passwordKey: ""
      # Property within the secret (for JSON secrets)
      passwordProperty: ""
      # Remote key path for username (optional, can be in same secret as password)
      usernameKey: ""
      usernameProperty: ""
      # Remote key for host (optional)
      hostKey: ""
      hostProperty: ""
      # Additional secrets to sync
      additionalSecrets: []
      # - secretKey: postgresql-port
      #   remoteKey: /floe/prod/dagster-db
      #   property: port

    # Compute engine credentials (Snowflake, BigQuery, Trino, etc.)
    # Creates secret: {{ fullname }}-compute-secret
    compute:
      enabled: false
      # List of secrets to sync
      secrets: []
      # Example for Snowflake:
      # - secretKey: SNOWFLAKE_ACCOUNT
      #   remoteKey: /floe/prod/snowflake
      #   property: account
      # - secretKey: SNOWFLAKE_USER
      #   remoteKey: /floe/prod/snowflake
      #   property: user
      # - secretKey: SNOWFLAKE_PASSWORD
      #   remoteKey: /floe/prod/snowflake
      #   property: password

    # Storage credentials (S3, GCS, ADLS)
    # Creates secret: {{ fullname }}-storage-secret
    storage:
      enabled: false
      # List of secrets to sync
      secrets: []
      # Example for S3:
      # - secretKey: AWS_ACCESS_KEY_ID
      #   remoteKey: /floe/prod/s3-credentials
      #   property: access_key
      # - secretKey: AWS_SECRET_ACCESS_KEY
      #   remoteKey: /floe/prod/s3-credentials
      #   property: secret_key

    # Catalog credentials (Polaris OAuth2)
    # Creates secret: {{ fullname }}-catalog-secret
    catalog:
      enabled: false
      # Polaris OAuth2 client credentials
      clientIdKey: ""
      clientIdProperty: ""
      clientSecretKey: ""
      clientSecretProperty: ""
      # Additional catalog secrets
      additionalSecrets: []

    # Custom external secrets
    # Creates secrets: {{ fullname }}-{{ name }} for each entry
    custom: []
    # Example:
    # - name: api-keys
    #   component: api
    #   secretStoreRef: ""  # Override default secretStoreRef
    #   refreshInterval: "30m"
    #   data:
    #     - secretKey: OPENAI_API_KEY
    #       remoteKey: /floe/prod/api-keys
    #       property: openai

  # Sealed Secrets integration
  # Encrypts secrets for safe storage in Git (GitOps compatible)
  # Requires: Sealed Secrets controller installed in cluster
  # Covers: 007-FR-003 (Sealed Secrets integration)
  sealedSecrets:
    # Enable Sealed Secrets integration
    enabled: false

    # Common annotations for all SealedSecret resources
    annotations: {}

    # PostgreSQL database credentials (encrypted)
    # Creates SealedSecret: {{ fullname }}-postgresql-secret
    postgresql:
      enabled: false
      # Encrypted data (generated with kubeseal)
      # kubeseal --raw --scope namespace-wide --name <secret-name> --namespace <ns>
      encryptedData: {}
      # postgresql-password: "AgBy3i4OJSWK+..."
      # postgresql-username: "AgBy8j9PLSWQ+..."

    # Compute engine credentials (encrypted)
    # Creates SealedSecret: {{ fullname }}-compute-secret
    compute:
      enabled: false
      encryptedData: {}
      # SNOWFLAKE_PASSWORD: "AgBy3i4OJSWK+..."

    # Storage credentials (encrypted)
    # Creates SealedSecret: {{ fullname }}-storage-secret
    storage:
      enabled: false
      encryptedData: {}
      # AWS_SECRET_ACCESS_KEY: "AgBy3i4OJSWK+..."

    # Catalog credentials (encrypted)
    # Creates SealedSecret: {{ fullname }}-catalog-secret
    catalog:
      enabled: false
      encryptedData: {}
      # polaris-client-secret: "AgBy3i4OJSWK+..."

    # Custom sealed secrets
    custom: []
    # - name: api-keys
    #   component: api
    #   encryptedData:
    #     API_KEY: "AgBy3i4OJSWK+..."

# Image configuration (for custom Dagster image with floe packages)
image:
  repository: ghcr.io/obsidian-owl/floe-dagster
  tag: ""  # Defaults to chart appVersion
  pullPolicy: IfNotPresent

# Image pull secrets for private registries
imagePullSecrets: []

# Resource defaults (override in values-prod.yaml)
resources:
  webserver:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  daemon:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Ingress configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: dagster.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# =============================================================================
# Local Access Configuration
# =============================================================================
# Provides NodePort access for local development.
# Disabled by default - enable in values-local.yaml
localAccess:
  enabled: false
  nodePort: 30000
