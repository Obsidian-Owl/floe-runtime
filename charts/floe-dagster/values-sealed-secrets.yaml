# Sealed Secrets Example
#
# This example shows how to configure floe-dagster with Sealed Secrets
# for secure secret storage in Git (GitOps-friendly).
#
# Prerequisites:
# 1. Sealed Secrets controller installed in cluster:
#    helm install sealed-secrets sealed-secrets/sealed-secrets -n kube-system
#
# 2. kubeseal CLI installed locally:
#    brew install kubeseal
#
# Covers: 007-FR-003 (Sealed Secrets integration)
#
# Workflow:
# 1. Create a raw secret value
# 2. Encrypt with kubeseal
# 3. Add encrypted value to this file
# 4. Commit to Git (safe to store encrypted values)
#
# Usage:
#   helm upgrade floe-dagster charts/floe-dagster \
#     -f charts/floe-dagster/values-sealed-secrets.yaml \
#     --namespace floe

# How to encrypt secrets:
#
# Step 1: Fetch the public key from your cluster
#   kubeseal --fetch-cert \
#     --controller-name=sealed-secrets \
#     --controller-namespace=kube-system \
#     > sealed-secrets-pub.pem
#
# Step 2: Encrypt individual values (namespace-wide scope)
#   echo -n "your-password" | kubeseal --raw \
#     --from-file=/dev/stdin \
#     --scope namespace-wide \
#     --name floe-dagster-postgresql-secret \
#     --namespace floe
#
# Step 3: Copy the encrypted output to this file

floe:
  sealedSecrets:
    enabled: true

    annotations:
      # Rotation timestamp (update to trigger re-encryption)
      sealed-secrets.bitnami.com/last-rotated: "2024-01-01T00:00:00Z"

    # PostgreSQL database credentials
    # Secret name: floe-dagster-postgresql-secret
    postgresql:
      enabled: true
      encryptedData:
        # Replace with your actual encrypted values from kubeseal
        # echo -n "dagster_password" | kubeseal --raw --scope namespace-wide \
        #   --name floe-dagster-postgresql-secret --namespace floe
        postgresql-password: "AgBy3i4OJSWK+PvPRpHfK8nRZQ..."
        postgresql-username: "AgCE8h7MKRTL+QvRRuIfM9oSQ..."

    # Snowflake compute credentials
    # Secret name: floe-dagster-compute-secret
    compute:
      enabled: true
      encryptedData:
        # echo -n "xy12345.us-west-2" | kubeseal --raw --scope namespace-wide \
        #   --name floe-dagster-compute-secret --namespace floe
        SNOWFLAKE_ACCOUNT: "AgBy3i4OJSWK..."
        SNOWFLAKE_USER: "AgCE8h7MKRTL..."
        SNOWFLAKE_PASSWORD: "AgDK9k2LPSVN..."
        SNOWFLAKE_WAREHOUSE: "AgEL0l3MQTWO..."
        SNOWFLAKE_DATABASE: "AgFM1m4NRUPX..."

    # S3 storage credentials
    # Secret name: floe-dagster-storage-secret
    storage:
      enabled: true
      encryptedData:
        AWS_ACCESS_KEY_ID: "AgBy3i4OJSWK..."
        AWS_SECRET_ACCESS_KEY: "AgCE8h7MKRTL..."

    # Polaris catalog credentials
    # Secret name: floe-dagster-catalog-secret
    catalog:
      enabled: true
      encryptedData:
        polaris-client-id: "AgBy3i4OJSWK..."
        polaris-client-secret: "AgCE8h7MKRTL..."

    # Custom secrets (e.g., dbt Cloud API token)
    custom:
      - name: dbt-cloud
        component: dbt
        encryptedData:
          DBT_CLOUD_API_TOKEN: "AgBy3i4OJSWK..."
          DBT_CLOUD_ACCOUNT_ID: "AgCE8h7MKRTL..."

# Override Dagster PostgreSQL configuration to use sealed secret
dagster:
  postgresql:
    enabled: false
  global:
    postgresqlSecretName: "floe-dagster-postgresql-secret"
    generatePostgresqlPasswordSecret: false
