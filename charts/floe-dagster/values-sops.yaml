# SOPS Encrypted Values Example
#
# This example shows how to use SOPS (Secrets OPerationS) to encrypt
# secret values in Helm values files.
#
# Prerequisites:
# 1. SOPS installed locally: brew install sops
# 2. Encryption key configured (age, GPG, AWS KMS, GCP KMS, or Azure Key Vault)
# 3. Helm Secrets plugin (optional): helm plugin install https://github.com/jkroepke/helm-secrets
#
# Covers: 007-FR-003 (SOPS integration)
#
# Workflow:
# 1. Create this file with plaintext values (for initial setup)
# 2. Encrypt with SOPS: sops -e values-sops.yaml > values-sops.enc.yaml
# 3. Commit encrypted file to Git
# 4. Decrypt at deploy time: sops -d values-sops.enc.yaml | helm upgrade ... -f -
#
# Usage with helm-secrets plugin:
#   helm secrets upgrade floe-dagster charts/floe-dagster \
#     -f charts/floe-dagster/values-sops.enc.yaml \
#     --namespace floe
#
# Usage without plugin:
#   sops -d charts/floe-dagster/values-sops.enc.yaml | \
#     helm upgrade floe-dagster charts/floe-dagster -f - \
#     --namespace floe

# SOPS Configuration (.sops.yaml in repo root)
# creation_rules:
#   - path_regex: .*values-sops\.yaml$
#     age: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
#     # OR for AWS KMS:
#     # kms: arn:aws:kms:us-west-2:123456789:key/abc123...
#     # OR for GCP KMS:
#     # gcp_kms: projects/my-project/locations/global/keyRings/my-ring/cryptoKeys/my-key

# Secret values - these will be encrypted by SOPS
# When you run `sops -e`, only the values (not keys) are encrypted
secrets:
  postgresql:
    password: "REPLACE_WITH_YOUR_POSTGRESQL_PASSWORD"
    username: "dagster"
    host: "dagster-db.example.com"
    port: "5432"
    database: "dagster"

  snowflake:
    account: "xy12345.us-west-2"
    user: "FLOE_SERVICE_ACCOUNT"
    password: "REPLACE_WITH_YOUR_SNOWFLAKE_PASSWORD"
    warehouse: "COMPUTE_WH"
    database: "FLOE_DB"
    schema: "PUBLIC"
    role: "FLOE_ROLE"

  s3:
    accessKeyId: "AKIAIOSFODNN7EXAMPLE"
    secretAccessKey: "REPLACE_WITH_YOUR_AWS_SECRET_KEY"
    region: "us-west-2"

  polaris:
    clientId: "abc123..."
    clientSecret: "REPLACE_WITH_YOUR_POLARIS_SECRET"

# Use the secrets in Dagster configuration
dagster:
  postgresql:
    enabled: false
  externalPostgresql:
    host: "{{ .Values.secrets.postgresql.host }}"
    port: "{{ .Values.secrets.postgresql.port }}"
    database: "{{ .Values.secrets.postgresql.database }}"
    user: "{{ .Values.secrets.postgresql.username }}"
    # Password from secret created below

# Create Kubernetes secrets from SOPS-decrypted values
# These templates create secrets at deploy time
floe:
  # Use raw secrets (not ExternalSecrets or SealedSecrets)
  # The secrets are created from SOPS-decrypted values
  externalSecrets:
    enabled: false
  sealedSecrets:
    enabled: false

# Note: When using SOPS with Helm, you typically:
# 1. Encrypt this values file: sops -e values-sops.yaml > values-sops.enc.yaml
# 2. Add a post-renderer or use helm-secrets to decrypt at deploy time
# 3. The decrypted values are passed to Helm templates

# Example Kubernetes Secret template (in templates/secret-sops.yaml):
# This template would reference the SOPS-decrypted values
#
# apiVersion: v1
# kind: Secret
# metadata:
#   name: {{ include "floe-dagster.fullname" . }}-postgresql-secret
# type: Opaque
# stringData:
#   postgresql-password: {{ .Values.secrets.postgresql.password | quote }}
#   postgresql-username: {{ .Values.secrets.postgresql.username | quote }}
