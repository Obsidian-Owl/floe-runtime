# Production Environment Values
#
# Override default values for production deployments.
# Use with: helm upgrade --install floe-dagster . -f values-prod.yaml
#
# Covers: 007-FR-002 (environment-specific Helm values)

# Enable Dagster subchart with production settings
dagster:
  enabled: true

  dagsterWebserver:
    replicaCount: 3
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi

    # Enable autoscaling in production
    autoscaling:
      enabled: true
      minReplicas: 3
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70

  dagsterDaemon:
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 2Gi

  # Use external PostgreSQL for production
  postgresql:
    enabled: false

  # External PostgreSQL configuration
  # Credentials should be provided via secrets
  externalPostgresql:
    host: ""  # Set via --set or external values
    port: 5432
    database: "dagster"
    sslMode: "require"

# Floe-specific production settings
floe:
  compiledArtifacts:
    enabled: true
    configMapName: "floe-prod-artifacts"
    mountPath: "/app/.floe/compiled_artifacts.json"
    annotations:
      # Force pod restart when artifacts change
      checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"

# Image pull secrets for private registry
imagePullSecrets:
  - name: registry-credentials

# Production ingress
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
  hosts:
    - host: dagster.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: dagster-tls
      hosts:
        - dagster.example.com
