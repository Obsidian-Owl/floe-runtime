{{/*
ConfigMap for Floe Platform Configuration

This ConfigMap holds the platform.yaml for Two-Tier Configuration Architecture.
It provides platform infrastructure configuration (storage, catalog, compute)
separate from pipeline logic (floe.yaml).

Two-Tier Architecture:
- Platform engineers configure: platform.yaml (endpoints, credentials, infrastructure)
- Data engineers configure: floe.yaml (pipelines, transforms, governance)
- Same floe.yaml works across environments via platform.yaml injection

Covers: 009-US2 (Same floe.yaml works across dev/staging/prod)
Covers: 009-FR-003 (Platform.yaml defines infrastructure profiles)
*/}}
{{- if .Values.floe.platformSpec.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "floe-dagster.fullname" . }}-platform
  labels:
    {{- include "floe-dagster.labels" . | nindent 4 }}
    app.kubernetes.io/component: platform-config
  annotations:
    {{- with .Values.floe.platformSpec.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
data:
  {{- if .Values.floe.platformSpec.content }}
  platform.yaml: |
    {{- .Values.floe.platformSpec.content | nindent 4 }}
  {{- else }}
  # Generated platform.yaml from Helm values
  # Two-Tier Architecture: Platform engineer configuration
  platform.yaml: |
    version: "1.0.0"

    storage:
      default:
        type: {{ .Values.floe.platformSpec.storage.type | default "s3" }}
        {{- if .Values.floe.platformSpec.storage.endpoint }}
        endpoint: {{ .Values.floe.platformSpec.storage.endpoint | quote }}
        {{- end }}
        region: {{ .Values.floe.platformSpec.storage.region | default "us-east-1" }}
        bucket: {{ .Values.floe.platformSpec.storage.bucket | default "iceberg-data" }}
        {{- if .Values.floe.platformSpec.storage.pathStyleAccess }}
        path_style_access: {{ .Values.floe.platformSpec.storage.pathStyleAccess }}
        {{- end }}
        credentials:
          mode: {{ .Values.floe.platformSpec.storage.credentials.mode | default "static" }}
          {{- if .Values.floe.platformSpec.storage.credentials.secretRef }}
          secret_ref: {{ .Values.floe.platformSpec.storage.credentials.secretRef }}
          {{- end }}
          {{- if .Values.floe.platformSpec.storage.credentials.roleArn }}
          role_arn: {{ .Values.floe.platformSpec.storage.credentials.roleArn | quote }}
          {{- end }}

    catalogs:
      default:
        type: {{ .Values.floe.platformSpec.catalog.type | default "polaris" }}
        uri: {{ .Values.floe.platformSpec.catalog.uri | quote }}
        warehouse: {{ .Values.floe.platformSpec.catalog.warehouse | default "demo_catalog" }}
        {{- if .Values.floe.platformSpec.catalog.namespace }}
        namespace: {{ .Values.floe.platformSpec.catalog.namespace }}
        {{- end }}
        credentials:
          mode: {{ .Values.floe.platformSpec.catalog.credentials.mode | default "oauth2" }}
          {{- if .Values.floe.platformSpec.catalog.credentials.clientId }}
          client_id: {{ .Values.floe.platformSpec.catalog.credentials.clientId }}
          {{- end }}
          {{- if .Values.floe.platformSpec.catalog.credentials.secretRef }}
          client_secret:
            secret_ref: {{ .Values.floe.platformSpec.catalog.credentials.secretRef }}
          {{- end }}
          {{- if .Values.floe.platformSpec.catalog.credentials.scope }}
          scope: {{ .Values.floe.platformSpec.catalog.credentials.scope | quote }}
          {{- end }}
        {{- if .Values.floe.platformSpec.catalog.accessDelegation }}
        access_delegation: {{ .Values.floe.platformSpec.catalog.accessDelegation }}
        {{- end }}
        {{- if .Values.floe.platformSpec.catalog.tokenRefreshEnabled }}
        token_refresh_enabled: {{ .Values.floe.platformSpec.catalog.tokenRefreshEnabled }}
        {{- end }}

    compute:
      default:
        type: {{ .Values.floe.platformSpec.compute.type | default "duckdb" }}
        {{- if .Values.floe.platformSpec.compute.properties }}
        properties:
          {{- toYaml .Values.floe.platformSpec.compute.properties | nindent 10 }}
        {{- end }}
        credentials:
          mode: {{ .Values.floe.platformSpec.compute.credentials.mode | default "static" }}
          {{- if .Values.floe.platformSpec.compute.credentials.secretRef }}
          secret_ref: {{ .Values.floe.platformSpec.compute.credentials.secretRef }}
          {{- end }}

    {{- if .Values.floe.platformSpec.observability }}
    observability:
      {{- if .Values.floe.platformSpec.observability.traces }}
      traces: {{ .Values.floe.platformSpec.observability.traces }}
      {{- end }}
      {{- if .Values.floe.platformSpec.observability.metrics }}
      metrics: {{ .Values.floe.platformSpec.observability.metrics }}
      {{- end }}
      {{- if .Values.floe.platformSpec.observability.lineage }}
      lineage: {{ .Values.floe.platformSpec.observability.lineage }}
      {{- end }}
      {{- if .Values.floe.platformSpec.observability.otlpEndpoint }}
      otlp_endpoint: {{ .Values.floe.platformSpec.observability.otlpEndpoint | quote }}
      {{- end }}
      {{- if .Values.floe.platformSpec.observability.lineageEndpoint }}
      lineage_endpoint: {{ .Values.floe.platformSpec.observability.lineageEndpoint | quote }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
