{{/*
External Secret Template for floe-dagster

Creates ExternalSecret resources to sync secrets from external providers
(AWS Secrets Manager, HashiCorp Vault, GCP Secret Manager, Azure Key Vault)
into Kubernetes Secrets.

Requires External Secrets Operator to be installed in the cluster:
  helm install external-secrets external-secrets/external-secrets -n external-secrets-system

Covers: 007-FR-003 (External Secrets integration)
*/}}
{{- if .Values.floe.externalSecrets.enabled }}
{{- $fullname := include "floe-dagster.fullname" . }}
{{- $labels := include "floe-dagster.labels" . }}

{{/*
PostgreSQL Database Secret - syncs database credentials from external provider
*/}}
{{- if .Values.floe.externalSecrets.postgresql.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $fullname }}-postgresql-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: database
  {{- with .Values.floe.externalSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.floe.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ required "externalSecrets.secretStoreRef is required when externalSecrets.enabled=true" .Values.floe.externalSecrets.secretStoreRef }}
    kind: {{ .Values.floe.externalSecrets.secretStoreKind | default "SecretStore" }}
  target:
    name: {{ $fullname }}-postgresql-secret
    creationPolicy: {{ .Values.floe.externalSecrets.creationPolicy | default "Owner" }}
    {{- if .Values.floe.externalSecrets.template.enabled }}
    template:
      engineVersion: v2
      data:
        # Template for constructing connection string if needed
        {{- if .Values.floe.externalSecrets.template.connectionString }}
        DAGSTER_PG_URL: "postgresql://{{ "{{ .username }}" }}:{{ "{{ .password }}" }}@{{ "{{ .host }}" }}:{{ "{{ .port | default \"5432\" }}" }}/{{ "{{ .database }}" }}"
        {{- end }}
    {{- end }}
  data:
    {{- if .Values.floe.externalSecrets.postgresql.passwordKey }}
    - secretKey: postgresql-password
      remoteRef:
        key: {{ .Values.floe.externalSecrets.postgresql.passwordKey }}
        {{- if .Values.floe.externalSecrets.postgresql.passwordProperty }}
        property: {{ .Values.floe.externalSecrets.postgresql.passwordProperty }}
        {{- end }}
    {{- end }}
    {{- if .Values.floe.externalSecrets.postgresql.usernameKey }}
    - secretKey: postgresql-username
      remoteRef:
        key: {{ .Values.floe.externalSecrets.postgresql.usernameKey }}
        {{- if .Values.floe.externalSecrets.postgresql.usernameProperty }}
        property: {{ .Values.floe.externalSecrets.postgresql.usernameProperty }}
        {{- end }}
    {{- end }}
    {{- if .Values.floe.externalSecrets.postgresql.hostKey }}
    - secretKey: postgresql-host
      remoteRef:
        key: {{ .Values.floe.externalSecrets.postgresql.hostKey }}
        {{- if .Values.floe.externalSecrets.postgresql.hostProperty }}
        property: {{ .Values.floe.externalSecrets.postgresql.hostProperty }}
        {{- end }}
    {{- end }}
    {{- range .Values.floe.externalSecrets.postgresql.additionalSecrets }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
---
{{- end }}

{{/*
Compute Engine Secret - syncs credentials for Snowflake, BigQuery, Trino, etc.
*/}}
{{- if .Values.floe.externalSecrets.compute.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $fullname }}-compute-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: compute
  {{- with .Values.floe.externalSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.floe.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.floe.externalSecrets.secretStoreRef }}
    kind: {{ .Values.floe.externalSecrets.secretStoreKind | default "SecretStore" }}
  target:
    name: {{ $fullname }}-compute-secret
    creationPolicy: {{ .Values.floe.externalSecrets.creationPolicy | default "Owner" }}
  data:
    {{- range .Values.floe.externalSecrets.compute.secrets }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
---
{{- end }}

{{/*
Storage/Catalog Secret - syncs credentials for S3, Polaris, etc.
*/}}
{{- if .Values.floe.externalSecrets.storage.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $fullname }}-storage-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: storage
  {{- with .Values.floe.externalSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.floe.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.floe.externalSecrets.secretStoreRef }}
    kind: {{ .Values.floe.externalSecrets.secretStoreKind | default "SecretStore" }}
  target:
    name: {{ $fullname }}-storage-secret
    creationPolicy: {{ .Values.floe.externalSecrets.creationPolicy | default "Owner" }}
  data:
    {{- range .Values.floe.externalSecrets.storage.secrets }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
---
{{- end }}

{{/*
Catalog Secret - syncs credentials for Polaris OAuth2
*/}}
{{- if .Values.floe.externalSecrets.catalog.enabled }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $fullname }}-catalog-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: catalog
  {{- with .Values.floe.externalSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.floe.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.floe.externalSecrets.secretStoreRef }}
    kind: {{ .Values.floe.externalSecrets.secretStoreKind | default "SecretStore" }}
  target:
    name: {{ $fullname }}-catalog-secret
    creationPolicy: {{ .Values.floe.externalSecrets.creationPolicy | default "Owner" }}
  data:
    {{- if .Values.floe.externalSecrets.catalog.clientIdKey }}
    - secretKey: polaris-client-id
      remoteRef:
        key: {{ .Values.floe.externalSecrets.catalog.clientIdKey }}
        {{- if .Values.floe.externalSecrets.catalog.clientIdProperty }}
        property: {{ .Values.floe.externalSecrets.catalog.clientIdProperty }}
        {{- end }}
    {{- end }}
    {{- if .Values.floe.externalSecrets.catalog.clientSecretKey }}
    - secretKey: polaris-client-secret
      remoteRef:
        key: {{ .Values.floe.externalSecrets.catalog.clientSecretKey }}
        {{- if .Values.floe.externalSecrets.catalog.clientSecretProperty }}
        property: {{ .Values.floe.externalSecrets.catalog.clientSecretProperty }}
        {{- end }}
    {{- end }}
    {{- range .Values.floe.externalSecrets.catalog.additionalSecrets }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
---
{{- end }}

{{/*
Custom Secrets - user-defined external secrets
*/}}
{{- range .Values.floe.externalSecrets.custom }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $fullname }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    {{- if .component }}
    app.kubernetes.io/component: {{ .component }}
    {{- end }}
  {{- with $.Values.floe.externalSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .refreshInterval | default ($.Values.floe.externalSecrets.refreshInterval | default "1h") }}
  secretStoreRef:
    name: {{ .secretStoreRef | default $.Values.floe.externalSecrets.secretStoreRef }}
    kind: {{ .secretStoreKind | default ($.Values.floe.externalSecrets.secretStoreKind | default "SecretStore") }}
  target:
    name: {{ $fullname }}-{{ .name }}
    creationPolicy: {{ .creationPolicy | default ($.Values.floe.externalSecrets.creationPolicy | default "Owner") }}
  data:
    {{- range .data }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteKey }}
        {{- if .property }}
        property: {{ .property }}
        {{- end }}
    {{- end }}
---
{{- end }}
{{- end }}
