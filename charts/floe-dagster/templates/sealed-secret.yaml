{{/*
Sealed Secret Template for floe-dagster

Creates SealedSecret resources that can be safely stored in Git.
The Sealed Secrets controller decrypts them into regular Kubernetes Secrets.

Requires Sealed Secrets controller to be installed in the cluster:
  helm install sealed-secrets sealed-secrets/sealed-secrets -n kube-system

Covers: 007-FR-003 (Sealed Secrets integration)
*/}}
{{- if .Values.floe.sealedSecrets.enabled }}
{{- $fullname := include "floe-dagster.fullname" . }}
{{- $labels := include "floe-dagster.labels" . }}

{{/*
PostgreSQL Database SealedSecret
The encryptedData must be generated using kubeseal:
  echo -n "password" | kubeseal --raw --scope namespace-wide --name floe-dagster-postgresql-secret --namespace floe
*/}}
{{- if .Values.floe.sealedSecrets.postgresql.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ $fullname }}-postgresql-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: database
  {{- with .Values.floe.sealedSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  encryptedData:
    {{- with .Values.floe.sealedSecrets.postgresql.encryptedData }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  template:
    metadata:
      name: {{ $fullname }}-postgresql-secret
      namespace: {{ $.Release.Namespace }}
      labels:
        {{- $labels | nindent 8 }}
        app.kubernetes.io/component: database
---
{{- end }}

{{/*
Compute Engine SealedSecret (Snowflake, BigQuery, Trino, etc.)
*/}}
{{- if .Values.floe.sealedSecrets.compute.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ $fullname }}-compute-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: compute
  {{- with .Values.floe.sealedSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  encryptedData:
    {{- with .Values.floe.sealedSecrets.compute.encryptedData }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  template:
    metadata:
      name: {{ $fullname }}-compute-secret
      namespace: {{ $.Release.Namespace }}
      labels:
        {{- $labels | nindent 8 }}
        app.kubernetes.io/component: compute
---
{{- end }}

{{/*
Storage SealedSecret (S3, GCS, ADLS credentials)
*/}}
{{- if .Values.floe.sealedSecrets.storage.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ $fullname }}-storage-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: storage
  {{- with .Values.floe.sealedSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  encryptedData:
    {{- with .Values.floe.sealedSecrets.storage.encryptedData }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  template:
    metadata:
      name: {{ $fullname }}-storage-secret
      namespace: {{ $.Release.Namespace }}
      labels:
        {{- $labels | nindent 8 }}
        app.kubernetes.io/component: storage
---
{{- end }}

{{/*
Catalog SealedSecret (Polaris OAuth2)
*/}}
{{- if .Values.floe.sealedSecrets.catalog.enabled }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ $fullname }}-catalog-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: catalog
  {{- with .Values.floe.sealedSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  encryptedData:
    {{- with .Values.floe.sealedSecrets.catalog.encryptedData }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  template:
    metadata:
      name: {{ $fullname }}-catalog-secret
      namespace: {{ $.Release.Namespace }}
      labels:
        {{- $labels | nindent 8 }}
        app.kubernetes.io/component: catalog
---
{{- end }}

{{/*
Custom SealedSecrets
*/}}
{{- range .Values.floe.sealedSecrets.custom }}
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: {{ $fullname }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- $labels | nindent 4 }}
    {{- if .component }}
    app.kubernetes.io/component: {{ .component }}
    {{- end }}
  {{- with $.Values.floe.sealedSecrets.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  encryptedData:
    {{- with .encryptedData }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  template:
    metadata:
      name: {{ $fullname }}-{{ .name }}
      namespace: {{ $.Release.Namespace }}
      labels:
        {{- $labels | nindent 8 }}
        {{- if .component }}
        app.kubernetes.io/component: {{ .component }}
        {{- end }}
---
{{- end }}
{{- end }}
