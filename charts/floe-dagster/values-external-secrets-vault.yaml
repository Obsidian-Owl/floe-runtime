# External Secrets with HashiCorp Vault
#
# This example shows how to configure floe-dagster to sync secrets
# from HashiCorp Vault using External Secrets Operator.
#
# Prerequisites:
# 1. External Secrets Operator installed in cluster
# 2. Vault server accessible from cluster
# 3. Vault authentication configured (Kubernetes auth, AppRole, or Token)
# 4. SecretStore configured to access Vault
#
# Covers: 007-FR-003 (External Secrets integration)
#
# Usage:
#   helm upgrade floe-dagster charts/floe-dagster \
#     -f charts/floe-dagster/values-external-secrets-vault.yaml \
#     --namespace floe
#
# Step 1: Configure Vault Kubernetes Auth:
#   vault auth enable kubernetes
#   vault write auth/kubernetes/config \
#     kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
#
# Step 2: Create Vault Policy for floe:
#   vault policy write floe-dagster - <<EOF
#   path "secret/data/floe/*" {
#     capabilities = ["read"]
#   }
#   EOF
#
# Step 3: Create Vault Role:
#   vault write auth/kubernetes/role/floe-dagster \
#     bound_service_account_names=external-secrets-sa \
#     bound_service_account_namespaces=floe \
#     policies=floe-dagster \
#     ttl=1h
#
# Step 4: Create SecretStore (kubectl apply):
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: vault-backend
#   namespace: floe
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com:8200"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "floe-dagster"
#           serviceAccountRef:
#             name: "external-secrets-sa"

floe:
  externalSecrets:
    enabled: true

    # Reference the Vault SecretStore
    secretStoreRef: "vault-backend"
    secretStoreKind: "SecretStore"

    # Refresh secrets every 15 minutes
    refreshInterval: "15m"

    # PostgreSQL credentials from Vault
    # Vault Path: secret/data/floe/dagster-postgresql
    # {
    #   "username": "dagster",
    #   "password": "your-secure-password",
    #   "host": "dagster-db.example.com",
    #   "port": "5432",
    #   "database": "dagster"
    # }
    postgresql:
      enabled: true
      # Vault path (without secret/data prefix - ESO adds it)
      passwordKey: "floe/dagster-postgresql"
      passwordProperty: "password"
      usernameKey: "floe/dagster-postgresql"
      usernameProperty: "username"
      hostKey: "floe/dagster-postgresql"
      hostProperty: "host"

    # Snowflake credentials from Vault
    # Vault Path: secret/data/floe/snowflake
    compute:
      enabled: true
      secrets:
        - secretKey: SNOWFLAKE_ACCOUNT
          remoteKey: "floe/snowflake"
          property: "account"
        - secretKey: SNOWFLAKE_USER
          remoteKey: "floe/snowflake"
          property: "user"
        - secretKey: SNOWFLAKE_PASSWORD
          remoteKey: "floe/snowflake"
          property: "password"
        - secretKey: SNOWFLAKE_WAREHOUSE
          remoteKey: "floe/snowflake"
          property: "warehouse"
        - secretKey: SNOWFLAKE_DATABASE
          remoteKey: "floe/snowflake"
          property: "database"
        - secretKey: SNOWFLAKE_SCHEMA
          remoteKey: "floe/snowflake"
          property: "schema"
        - secretKey: SNOWFLAKE_ROLE
          remoteKey: "floe/snowflake"
          property: "role"

    # S3 credentials from Vault
    # Vault Path: secret/data/floe/s3-credentials
    storage:
      enabled: true
      secrets:
        - secretKey: AWS_ACCESS_KEY_ID
          remoteKey: "floe/s3-credentials"
          property: "access_key"
        - secretKey: AWS_SECRET_ACCESS_KEY
          remoteKey: "floe/s3-credentials"
          property: "secret_key"
        - secretKey: AWS_REGION
          remoteKey: "floe/s3-credentials"
          property: "region"

    # Polaris catalog OAuth2 credentials
    # Vault Path: secret/data/floe/polaris
    catalog:
      enabled: true
      clientIdKey: "floe/polaris"
      clientIdProperty: "client_id"
      clientSecretKey: "floe/polaris"
      clientSecretProperty: "client_secret"

    # Custom secrets: dbt Cloud credentials, API keys, etc.
    custom:
      - name: dbt-cloud
        component: dbt
        refreshInterval: "1h"
        data:
          - secretKey: DBT_CLOUD_API_TOKEN
            remoteKey: "floe/dbt-cloud"
            property: "api_token"
          - secretKey: DBT_CLOUD_ACCOUNT_ID
            remoteKey: "floe/dbt-cloud"
            property: "account_id"

# Override Dagster PostgreSQL configuration to use external secret
dagster:
  postgresql:
    enabled: false
  global:
    postgresqlSecretName: "floe-dagster-postgresql-secret"
    generatePostgresqlPasswordSecret: false
