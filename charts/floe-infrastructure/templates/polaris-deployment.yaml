{{- if .Values.polaris.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-polaris
  labels:
    {{- include "floe-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: polaris
spec:
  replicas: {{ .Values.polaris.replicaCount | default 1 }}
  selector:
    matchLabels:
      {{- include "floe-infrastructure.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: polaris
  template:
    metadata:
      labels:
        {{- include "floe-infrastructure.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: polaris
    spec:
      containers:
        - name: polaris
          image: "{{ .Values.polaris.image.repository }}:{{ .Values.polaris.image.tag }}"
          imagePullPolicy: {{ .Values.polaris.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http
              containerPort: 8181
              protocol: TCP
            - name: management
              containerPort: 8182
              protocol: TCP
          env:
            # Bootstrap credentials for Polaris root principal
            # Format: REALM,CLIENT_ID,CLIENT_SECRET
            # This pre-sets the root credentials instead of auto-generating
            - name: POLARIS_BOOTSTRAP_CREDENTIALS
              value: "POLARIS,{{ .Values.polarisInit.oauthClientId | default "demo_client" }},{{ .Values.polarisInit.oauthClientSecret | default "demo_secret" }}"
            {{- if .Values.localstack.enabled }}
            # LocalStack credentials (any value works for LocalStack)
            - name: AWS_ACCESS_KEY_ID
              value: "test"
            - name: AWS_SECRET_ACCESS_KEY
              value: "test"
            - name: AWS_ENDPOINT_URL
              value: {{ include "floe-infrastructure.localstack.endpoint" . | quote }}
            {{- else }}
            # MinIO/S3 credentials for storage access
            - name: AWS_ACCESS_KEY_ID
              value: {{ .Values.minio.rootUser | default "minioadmin" | quote }}
            - name: AWS_SECRET_ACCESS_KEY
              value: {{ .Values.minio.rootPassword | default "minioadmin" | quote }}
            {{- end }}
            - name: AWS_REGION
              value: {{ .Values.localstack.region | default "us-east-1" | quote }}
          livenessProbe:
            httpGet:
              path: /q/health/live
              port: management
            initialDelaySeconds: {{ ((.Values.polaris).livenessProbe).initialDelaySeconds | default 30 }}
            periodSeconds: {{ ((.Values.polaris).livenessProbe).periodSeconds | default 10 }}
            failureThreshold: {{ ((.Values.polaris).livenessProbe).failureThreshold | default 3 }}
          readinessProbe:
            httpGet:
              path: /q/health/ready
              port: management
            initialDelaySeconds: {{ ((.Values.polaris).readinessProbe).initialDelaySeconds | default 10 }}
            periodSeconds: {{ ((.Values.polaris).readinessProbe).periodSeconds | default 5 }}
            failureThreshold: {{ ((.Values.polaris).readinessProbe).failureThreshold | default 3 }}
          resources:
            {{- toYaml .Values.polaris.resources | nindent 12 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-polaris
  labels:
    {{- include "floe-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: polaris
spec:
  {{- if and .Values.localAccess .Values.localAccess.enabled }}
  type: NodePort
  {{- else }}
  type: ClusterIP
  {{- end }}
  ports:
    - port: 8181
      targetPort: http
      protocol: TCP
      name: http
      {{- if and .Values.localAccess .Values.localAccess.enabled .Values.localAccess.nodeports }}
      nodePort: {{ .Values.localAccess.nodeports.polaris | default 30181 }}
      {{- end }}
    - port: 8182
      targetPort: management
      protocol: TCP
      name: management
  selector:
    {{- include "floe-infrastructure.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: polaris
{{- end }}
