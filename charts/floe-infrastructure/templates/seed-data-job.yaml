{{- if .Values.seedData.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-seed-data
  labels:
    {{- include "floe-infrastructure.labels" . | nindent 4 }}
    app.kubernetes.io/component: seed-data
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "floe-infrastructure.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: seed-data
    spec:
      restartPolicy: Never
      initContainers:
        # Wait for Polaris to be ready
        - name: wait-for-polaris
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Polaris to be ready..."
              until wget -q --spider http://{{ .Release.Name }}-polaris:8182/q/health/ready; do
                echo "Polaris not ready, waiting..."
                sleep 5
              done
              echo "Polaris is ready!"
      containers:
        - name: seed-data
          image: {{ .Values.seedData.image.repository }}:{{ .Values.seedData.image.tag }}
          imagePullPolicy: {{ .Values.seedData.image.pullPolicy }}
          command:
            - python
            - -c
            - |
              """Seed Iceberg tables with demo data for the raw layer.

              This script creates demo.raw_* tables that represent pre-staged
              data from an ELT pipeline. Bronze layer assets then load from
              these tables, demonstrating a real-world data flow.

              Tables created:
              - demo.raw_customers (1000 rows)
              - demo.raw_products (100 rows)
              - demo.raw_orders (5000 rows)
              - demo.raw_order_items (10000 rows)
              """
              import os
              import sys
              from pydantic import SecretStr

              # Configuration from environment
              POLARIS_URI = os.environ["POLARIS_URI"]
              POLARIS_WAREHOUSE = os.environ["POLARIS_WAREHOUSE"]
              POLARIS_CLIENT_ID = os.environ["POLARIS_CLIENT_ID"]
              POLARIS_CLIENT_SECRET = os.environ["POLARIS_CLIENT_SECRET"]
              S3_ENDPOINT = os.environ["AWS_ENDPOINT_URL"]
              S3_ACCESS_KEY = os.environ["AWS_ACCESS_KEY_ID"]
              S3_SECRET_KEY = os.environ["AWS_SECRET_ACCESS_KEY"]
              S3_REGION = os.environ.get("AWS_REGION", "us-east-1")

              SEED = int(os.environ.get("DEMO_SEED", "42"))
              CUSTOMERS_COUNT = int(os.environ.get("DEMO_CUSTOMERS_COUNT", "1000"))
              PRODUCTS_COUNT = int(os.environ.get("DEMO_PRODUCTS_COUNT", "100"))
              ORDERS_COUNT = int(os.environ.get("DEMO_ORDERS_COUNT", "5000"))
              ORDER_ITEMS_COUNT = int(os.environ.get("DEMO_ORDER_ITEMS_COUNT", "10000"))

              print("="*60)
              print("FLOE DEMO - Seeding Iceberg Tables")
              print("="*60)
              print(f"Polaris URI: {POLARIS_URI}")
              print(f"Warehouse: {POLARIS_WAREHOUSE}")
              print(f"S3 Endpoint: {S3_ENDPOINT}")
              print(f"Seed: {SEED}")
              print()

              # Import floe packages
              try:
                  from floe_polaris.client import PolarisCatalog
                  from floe_polaris.config import PolarisCatalogConfig
                  from floe_iceberg.tables import IcebergTableManager
                  from floe_synthetic.generators.ecommerce import EcommerceGenerator
              except ImportError as e:
                  print(f"ERROR: Failed to import floe packages: {e}")
                  print("Make sure the image includes floe-polaris, floe-iceberg, floe-synthetic")
                  sys.exit(1)

              # Configure Polaris catalog
              config = PolarisCatalogConfig(
                  uri=POLARIS_URI,
                  warehouse=POLARIS_WAREHOUSE,
                  client_id=POLARIS_CLIENT_ID,
                  client_secret=SecretStr(POLARIS_CLIENT_SECRET),
                  scope="PRINCIPAL_ROLE:ALL",
                  s3_endpoint=S3_ENDPOINT,
                  s3_region=S3_REGION,
                  s3_path_style_access=True,
                  s3_access_key_id=S3_ACCESS_KEY,
                  s3_secret_access_key=SecretStr(S3_SECRET_KEY),
              )

              print("Creating Polaris catalog connection...")
              try:
                  catalog = PolarisCatalog(config)
                  manager = IcebergTableManager(catalog.inner_catalog)
                  print("✅ Connected to Polaris catalog")
              except Exception as e:
                  print(f"ERROR: Failed to connect to Polaris: {e}")
                  sys.exit(1)

              # Generate synthetic data
              print()
              print("Generating synthetic e-commerce data...")
              generator = EcommerceGenerator(seed=SEED)

              # Generate data with proper FK relationships
              customers = generator.generate_customers(count=CUSTOMERS_COUNT)
              products = generator.generate_products(count=PRODUCTS_COUNT)
              orders = generator.generate_orders(count=ORDERS_COUNT)
              order_items = generator.generate_order_items(count=ORDER_ITEMS_COUNT)

              print(f"  ✅ Customers: {customers.num_rows} rows")
              print(f"  ✅ Products: {products.num_rows} rows")
              print(f"  ✅ Orders: {orders.num_rows} rows")
              print(f"  ✅ Order Items: {order_items.num_rows} rows")

              # Define tables to seed
              tables = [
                  ("demo.raw_customers", customers),
                  ("demo.raw_products", products),
                  ("demo.raw_orders", orders),
                  ("demo.raw_order_items", order_items),
              ]

              # Seed tables
              print()
              print("Seeding Iceberg tables...")
              for table_id, data in tables:
                  print(f"  Seeding {table_id}...")
                  try:
                      # Create table if not exists
                      manager.create_table_if_not_exists(table_id, data.schema)
                      # Overwrite with fresh data
                      snapshot = manager.overwrite(table_id, data)
                      print(f"    ✅ {table_id}: {data.num_rows} rows (snapshot: {snapshot.snapshot_id})")
                  except Exception as e:
                      print(f"    ❌ Failed to seed {table_id}: {e}")
                      # Continue with other tables

              print()
              print("="*60)
              print("✅ Demo seed data complete!")
              print("="*60)
              print()
              print("Raw layer tables are ready for bronze layer assets to process.")
              print("Run the Dagster demo_bronze job to transform raw → bronze.")
          env:
            - name: POLARIS_URI
              value: "http://{{ .Release.Name }}-polaris:8181/api/catalog"
            - name: POLARIS_WAREHOUSE
              value: {{ .Values.polarisInit.catalogName | quote }}
            - name: POLARIS_CLIENT_ID
              value: {{ .Values.polarisInit.oauthClientId | default "demo_client" | quote }}
            - name: POLARIS_CLIENT_SECRET
              value: {{ .Values.polarisInit.oauthClientSecret | default "demo_secret" | quote }}
            - name: AWS_ENDPOINT_URL
              value: {{ include "floe-infrastructure.storage.endpoint" . | quote }}
            - name: AWS_ACCESS_KEY_ID
              value: {{ .Values.seedData.awsAccessKeyId | default "minioadmin" | quote }}
            - name: AWS_SECRET_ACCESS_KEY
              value: {{ .Values.seedData.awsSecretAccessKey | default "minioadmin" | quote }}
            - name: AWS_REGION
              value: {{ .Values.localstack.region | default "us-east-1" | quote }}
            - name: DEMO_SEED
              value: {{ .Values.seedData.seed | default "42" | quote }}
            - name: DEMO_CUSTOMERS_COUNT
              value: {{ .Values.seedData.customersCount | default "1000" | quote }}
            - name: DEMO_PRODUCTS_COUNT
              value: {{ .Values.seedData.productsCount | default "100" | quote }}
            - name: DEMO_ORDERS_COUNT
              value: {{ .Values.seedData.ordersCount | default "5000" | quote }}
            - name: DEMO_ORDER_ITEMS_COUNT
              value: {{ .Values.seedData.orderItemsCount | default "10000" | quote }}
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
{{- end }}
